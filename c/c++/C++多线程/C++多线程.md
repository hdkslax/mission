# 并发与多线程

## 1. 并发、进程、线程

#### 1.1 并发

两个或更多的任务（独立的任务）同时发生（进行）：一个程序同时执行多个独立的任务。

- 单核处理器（中央处理器）：某一个时刻只能执行一个任务：由操作系统调度，每秒钟进行多次的“任务切换”。
  - 并发的假象，不是真正的并发。
  - 这种切换叫做上下文切换，有时间开销（切换时要保存切换时的各种状态，执行进度等信息，切回来还要复原这些信息，都需要时间）
- 多处理器计算机：一块芯片上有多核（多个CPU）
  - 能够实现真正的并行执行多个任务
  - 硬件并发

#### 1.2 可执行程序

磁盘上一个文件，windows下，扩展名为.exe；linux上，ls -la, rwxrwxrwx, x为可执行权限

#### 1.3 进程

- 一个可执行程序运行起来了，就叫做创建了一个进程。
- 进程：运行起来了的可执行程序。

#### 1.4 线程

- 每个进程（执行起来的可执行程序），都有一个主线程，这个主线程是唯一的。
- 当执行可执行程序时，产生一个进程后，这个主线程就跟随这这个进程默默的启动起来了。
  - 比如要执行自己写的c++程序时，实际上是进程的主线程来执行（调用）main函数中的代码。
- 除了主线程外，我们可以通过自己写代码来创建其他线程
  - 其他线程走的是别的道路，甚至去不同的地方
  - 每创建一个新线程，就可以在同一个时刻多干一件不同的事（多走一条不同的代码执行路径）
- 线程并不是越多越好。每个线程都要有一个独立的栈空间（堆是共享的），线程之间的切换要保存很多中间状态；
  - 切换会耗费本该属于程序运行的时间。

## 2. 并发

两个或更多的任务（独立的活动）同时发生（进行）

实现并发的手段：

1. 通过多个进程实现并发。
2. 在单独的进程中，创建多个线程来实现并发；自己写代码来创建除了主线程之外的其他线程

#### 2.1 多进程并发

- word启动就是进程，浏览器启动就是进程。
- 账号服务器，游戏逻辑服务器，服务器进程之间的通信。
- 进程之间的通信（同一个电脑上：管道，文件，消息队列，共享内存）
- 不同电脑间通信：socket通信技术

#### 2.2 多线程并发

单个进程中，创建了多个线程

- 线程，像是轻量级的进程，每个线程都有自己独立的运行路径，但是一个进程中所有线程共享地址空间（共享内存）
  - 全局变量、指针、引用都可以在线程之间传递。使用多线程开销远远小于多线程
- 共享内存带来新问题，数据一致性问题

多进程并发和多线程并发可以混合使用，但建议优先考虑多线程技术手段。



#### 2.3 C++11新标准线程库

- 以往多线程不能跨平台

- windows
  - 创建线程: `CreateThread()`, `_beginthread()`, `_beginthreadexe()`
- Linux
  - 创建线程：`pthread_create()`
- POSIX `thread(pthread)` 实现了跨平台库

从C++11开始，C++语言本身增加了对多线程的支持（可移植到不同平台啦）









## 3. 线程启动、结束，创建线程多法、join、detach

- 程序运行起来，生成一个进程，该进程所属的主线程开始自动运行
- 主线程从`main()`函数开始执行，那么我们自己创建的线程，也需要从一个函数开始执行（初始函数），一旦这个函数运行完毕，就代表着我们这个线程运行结束。
- 整个进程是否执行完毕的标志是：主线程是否执行完；若主线程执行完毕，则整个进程执行完毕；此时，若其他子线程还没有执行完，那么这些子线程也会被操作系统强行终止。
- 所以，一般情况下，若想保持子线程的运行状态，则必须让主线程一直保持运行，不能让主线程运行完毕。
- 上条规矩有例外，请往下看。

#### 3.0 头文件

`#include <thread>`

#### 3.1 线程启动

- 写初始函数

